<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>源码分析——服务发现组件Netflix Eureka - i蝸居年華_谢谢谢_CODE_HOME</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="[TOC] 前言结合Netflix Eureka 架构图, 简单分析这一服务注册和服务发现组件的源码"><meta name="keywords" content="微服务"><meta property="og:type" content="article"><meta property="og:title" content="源码分析——服务发现组件Netflix Eureka"><meta property="og:url" content="https://xiefayang.com/2019/04/16/源码分析—服务发现组件Netflix Eureka/index.html"><meta property="og:site_name" content="i蝸居年華_谢谢谢_CODE_HOME"><meta property="og:description" content="[TOC] 前言结合Netflix Eureka 架构图, 简单分析这一服务注册和服务发现组件的源码"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://xiefayang.com/thumbnails/eureka-logo-600.png"><meta property="og:updated_time" content="2019-04-29T03:30:01.655Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="源码分析——服务发现组件Netflix Eureka"><meta name="twitter:description" content="[TOC] 前言结合Netflix Eureka 架构图, 简单分析这一服务注册和服务发现组件的源码"><meta name="twitter:image" content="https://xiefayang.com/thumbnails/eureka-logo-600.png"><link rel="icon" href="/images/favicon.svg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><link rel="stylesheet" href="/css/back-to-top.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?b59777544dd5d59ce94e191bac62427c";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="/css/progressbar.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><link rel="stylesheet" href="/css/style.css"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand is-flex-center"> <a class="navbar-item navbar-logo" href="/"><img src="/images/maotouying.svg" alt="源码分析——服务发现组件Netflix Eureka" height="28"> <span style="font-size:16px;display:inline-block;vertical-align:top;font-weight:600">i蝸居年華_谢谢谢</span></a></div><div class="navbar-menu"><div class="navbar-start"> <a class="navbar-item" href="/">首页</a> <a class="navbar-item" href="/archives">归档</a> <a class="navbar-item" href="/categories">分类</a> <a class="navbar-item" href="/tags">标签</a> <a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="文章目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><div class="box01"> <input type="text" id="tip" placeholder="You Know, for Search~"><i class="search_icon"></i></div></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main"><div class="card"><div class="card-content article"><div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto"><div class="level-left"> <span style="color:#7a7a7a!important">写于2019-04-16 18:01:37&nbsp;&nbsp;&nbsp;</span><div class="level-item"> <a class="has-link-grey -link" href="/categories/微服务专题/">微服务专题</a></div> <span class="level-item has-text-grey">24 分钟 读完 (大约 3526 个字)</span><span class="level-item has-text-grey" id="busuanzi_container_page_pv"><i class="far fa-eye"></i> <span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal"> 源码分析——服务发现组件Netflix Eureka</h1><div class="content"><p>[TOC]</p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a><strong>前言</strong></h2><p>结合<a href="https://github.com/Netflix/eureka" target="_blank" rel="noopener">Netflix Eureka</a> 架构图, 简单分析这一服务注册和服务发现组件的源码</p><a id="more"></a><p><strong>目的</strong></p><p>结合Netflix Eureka架构图</p><ul><li>从源码解读Eureka架构图中服务生命周期<ul><li>Register: 服务注册</li><li>Renew: 服务续约</li><li>Cancel: 服务下线</li><li>Evict: 服务剔除(Servcer端)</li></ul></li><li>从源码解读Eureka Peer Replicate过程</li><li>总结其一致性问题</li></ul><h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a><strong>说明</strong></h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a><strong>环境准备</strong></h3><p>源码获取: <a href="https://github.com/Netflix/eureka" target="_blank" rel="noopener">https://github.com/Netflix/eureka</a></p><p>项目结构如下:<br></p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">eureka-client</span><br><span class="line">eureka-client-archaius2</span><br><span class="line">eureka-client-jersey2</span><br><span class="line">eureka-core</span><br><span class="line">eureka-core-jersey2</span><br><span class="line">eureka-examples</span><br><span class="line">eureka-resources</span><br><span class="line">eureka-server</span><br><span class="line">eureka-server-governator</span><br><span class="line">eureka-test-utils</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p></p><p>本章节中只需要关注eureka-core和eureka-client两个模块</p><p>项目是纯Servlet应用, 使用Gradle构建, 这里我只是作为参照并没有构建, 在集成了Spring Cloud Netflix Eureka的项目中进行源码调试</p><ul><li>Spring Cloud: Finchley.SR2</li><li>Spring Boot: 2.0.8.RELEASE</li></ul><p>对应的Netflix Eureka版本为: <code>v1.9.3</code></p><figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span> git checkout -b v1.9.3 v1.9.3</span><br></pre></td></tr></table></figure><p>在Spring Cloud集成Netflix Eureka的代码中, 还能看到两个与Eureka相关的包</p><ul><li>spring-cloud-netflix-eureka-server</li><li>spring-cloud-netflix-eureka-client</li></ul><p>这部分代码被称为胶水代码, 包含一些原生代码针对Spring项目的支持, 一些默认配置等</p><p>以及我们最熟悉的 Eureka Dashboard 界面, 都是由这部分代码完成</p><p><br></p><h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a><strong>架构图</strong></h3><p>引用官方wiki中的架构图</p><p><img src="https://raw.githubusercontent.com/Netflix/eureka/master/images/eureka_architecture.png" alt="High level architecture"></p><p>所以源码分析的角度就是上图中画直线的部分, 可以总结为两部分</p><ul><li>Eureka Server之间的Replicate</li><li>Eureka Client 与 Eureka Server之间的Register, Renew, Cancel…</li></ul><p>对于Eureka Client, 我们还应该区分这样两个逻辑角色</p><ul><li>Service Provider: 服务提供者</li><li>Service Consumer: 服务消费者</li></ul><p>无论客户端发现还是服务端发现, 服务发现的本质在于能够让服务之间发现彼此, 这是服务提供方与服务消费方完成消费的前提, 对应架构图中的Client端之间的Remote Call</p><p><br></p><h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a><strong>源码解析</strong></h2><p><br></p><h3 id="Eureka-Server"><a href="#Eureka-Server" class="headerlink" title="Eureka Server"></a><strong>Eureka Server</strong></h3><h4 id="启动入口"><a href="#启动入口" class="headerlink" title="启动入口"></a>启动入口</h4><p>随着Eureka Server启动时的一行INFO日志<code>Started Eureka Server</code></p><p>来到第一个入口点: <code>EurekaServerInitializerConfiguration#start</code></p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Configuration</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaServerInitializerConfiguration</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ServletContextAware</span>, <span class="hljs-title">SmartLifecycle</span>, <span class="hljs-title">Ordered</span> </span>&#123;</span><br><span class="line">	<span class="hljs-comment">// ...</span></span><br><span class="line">	<span class="hljs-meta">@Override</span></span><br><span class="line">	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">		<span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="hljs-meta">@Override</span></span><br><span class="line">			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">				<span class="hljs-keyword">try</span> &#123;</span><br><span class="line">					<span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> is this class even needed now?</span></span><br><span class="line">					eurekaServerBootstrap.contextInitialized(EurekaServerInitializerConfiguration.<span class="hljs-keyword">this</span>.servletContext);</span><br><span class="line">					log.info(<span class="hljs-string">"Started Eureka Server"</span>);</span><br><span class="line"></span><br><span class="line">					publish(<span class="hljs-keyword">new</span> EurekaRegistryAvailableEvent(getEurekaServerConfig()));</span><br><span class="line">					EurekaServerInitializerConfiguration.<span class="hljs-keyword">this</span>.running = <span class="hljs-keyword">true</span>;</span><br><span class="line">					publish(<span class="hljs-keyword">new</span> EurekaServerStartedEvent(getEurekaServerConfig()));</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="hljs-keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">					<span class="hljs-comment">// Help!</span></span><br><span class="line">					log.error(<span class="hljs-string">"Could not initialize Eureka servlet context"</span>, ex);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;).start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>^_^注释很有意思</p><p>这里看到了一个启动引导类<code>EurekaServerBootstrap</code></p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">contextInitialized</span><span class="hljs-params">(ServletContext context)</span> </span>&#123;</span><br><span class="line">	<span class="hljs-keyword">try</span> &#123;</span><br><span class="line">		initEurekaEnvironment();</span><br><span class="line">		initEurekaServerContext();</span><br><span class="line"></span><br><span class="line">		context.setAttribute(EurekaServerContext.class.getName(), <span class="hljs-keyword">this</span>.serverContext);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">		log.error(<span class="hljs-string">"Cannot bootstrap eureka server :"</span>, e);</span><br><span class="line">		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"Cannot bootstrap eureka server :"</span>, e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同样在eureka-core中也存在一个引导类<code>EurekaBootStrap</code> 这是Eureka Server的启动类, 代码与<code>EurekaServerBootstrap</code>基本类似</p><p>作用也基本相似, 都是完成eureka的初始化工作</p><p>不同的是<code>EurekaBootStrap</code>实现了Servlet API中的<code>ServletContextListener</code>接口</p><p>所以在容器启动时就会调用<code>contextInitialized()</code>方法完成init过程, 以及在终止时的<code>contextDestroyed()</code></p><p>在这个引导类中, 还能够看到两个与配置相关的接口:</p><ul><li><code>EurekaServerConfig eurekaServerConfig;</code></li><li><code>EurekaClientConfig eurekaClientConfig;</code></li></ul><p>没错, Eureka Server 和 Eureka Client的配置都在这里, 他们分别对应两个实现类:</p><ul><li>DefaultEurekaServerConfig implements EurekaServerConfig</li><li>EurekaServerConfigBean implements EurekaServerConfig</li></ul><p>一个是提供默认配置的类, 在netflix eureka源码中, 另一个在Spring Cloud Netflix的整合代码中, 是添加了<code>@ConfigurationProperties</code>的属性配置类, 前缀为<code>eureka.server</code></p><p>很熟悉吧? 对应于我们平时在配置文件中配置的<code>eureka.server.xxx</code>.</p><p>Eureka Client端的EurekaClientConfig与之类似, 不说了</p><p><br></p><h4 id="Resources-API"><a href="#Resources-API" class="headerlink" title="Resources API"></a>Resources API</h4><p>从上面的架构图可以看到, Eureka Client需要向Eureka Server进行注册, 发送心跳更新租约, 获取注册信息等;</p><p>同时Eureka Server之间也要进行注册信息的同步</p><p>所以在Eureka Server中, 一定有对外提供REST API的入口, 这就是Resources中的内容, 你可以认为是控制器~</p><p>这部分代码在eureka-core中的<code>com.netflix.eureka.resources</code>中:</p><ul><li>ApplicationResource</li><li>InstanceResource</li><li>PeerReplicationResource</li><li>etc…</li></ul><p>通过类名上的@Path注解, 或是类名. 不难分辨他们分别代表什么资源</p><p><br></p><h4 id="Register-amp-Renew-amp-Cancel"><a href="#Register-amp-Renew-amp-Cancel" class="headerlink" title="Register&amp;Renew&amp;Cancel"></a>Register&amp;Renew&amp;Cancel</h4><p>来看一个服务注册-register的API, 在<code>ApplicationResource</code>中<br></p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@POST</span></span><br><span class="line"><span class="hljs-meta">@Consumes</span>(&#123;<span class="hljs-string">"application/json"</span>, <span class="hljs-string">"application/xml"</span>&#125;)</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">addInstance</span><span class="hljs-params">(InstanceInfo info,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                            @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication) </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// validate required fields...</span></span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">// handle cases where clients may be registering with bad DataCenterInfo with missing data</span></span><br><span class="line">    <span class="hljs-comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    registry.register(info, <span class="hljs-string">"true"</span>.equals(isReplication));</span><br><span class="line">    <span class="hljs-keyword">return</span> Response.status(<span class="hljs-number">204</span>).build();  <span class="hljs-comment">// 204 to be backwards compatible</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>我们可以模拟一个客户端调用看看: <code>com.netflix.eureka.resources.ApplicationResource#getApplication</code></p><blockquote><p>GET <a href="http://localhost:8761/eureka/apps/CLOUDLINK-USER" target="_blank" rel="noopener">http://localhost:8761/eureka/apps/CLOUDLINK-USER</a></p></blockquote><p>返回结果如下:</p><figure class="highlight xml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">application</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>CLOUDLINK-USER<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">instance</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">instanceId</span>&gt;</span>192.168.153.1:cloudlink-user:8801<span class="hljs-tag">&lt;/<span class="hljs-name">instanceId</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">hostName</span>&gt;</span>localhost<span class="hljs-tag">&lt;/<span class="hljs-name">hostName</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">app</span>&gt;</span>CLOUDLINK-USER<span class="hljs-tag">&lt;/<span class="hljs-name">app</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">ipAddr</span>&gt;</span>192.168.153.1<span class="hljs-tag">&lt;/<span class="hljs-name">ipAddr</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">status</span>&gt;</span>UP<span class="hljs-tag">&lt;/<span class="hljs-name">status</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">overriddenstatus</span>&gt;</span>UNKNOWN<span class="hljs-tag">&lt;/<span class="hljs-name">overriddenstatus</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">port</span> <span class="hljs-attr">enabled</span>=<span class="hljs-string">"true"</span>&gt;</span>8801<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">securePort</span> <span class="hljs-attr">enabled</span>=<span class="hljs-string">"false"</span>&gt;</span>443<span class="hljs-tag">&lt;/<span class="hljs-name">securePort</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">countryId</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">countryId</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">dataCenterInfo</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo"</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>MyOwn<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">dataCenterInfo</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">leaseInfo</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">renewalIntervalInSecs</span>&gt;</span>30<span class="hljs-tag">&lt;/<span class="hljs-name">renewalIntervalInSecs</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">durationInSecs</span>&gt;</span>90<span class="hljs-tag">&lt;/<span class="hljs-name">durationInSecs</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">registrationTimestamp</span>&gt;</span>1555462894529<span class="hljs-tag">&lt;/<span class="hljs-name">registrationTimestamp</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">lastRenewalTimestamp</span>&gt;</span>1555463085849<span class="hljs-tag">&lt;/<span class="hljs-name">lastRenewalTimestamp</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">evictionTimestamp</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">evictionTimestamp</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">serviceUpTimestamp</span>&gt;</span>1555462894529<span class="hljs-tag">&lt;/<span class="hljs-name">serviceUpTimestamp</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">leaseInfo</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">metadata</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">management.port</span>&gt;</span>8801<span class="hljs-tag">&lt;/<span class="hljs-name">management.port</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">metadata</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">homePageUrl</span>&gt;</span>http://localhost:8801/<span class="hljs-tag">&lt;/<span class="hljs-name">homePageUrl</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">statusPageUrl</span>&gt;</span>http://localhost:8801/actuator/info<span class="hljs-tag">&lt;/<span class="hljs-name">statusPageUrl</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">healthCheckUrl</span>&gt;</span>http://localhost:8801/actuator/health<span class="hljs-tag">&lt;/<span class="hljs-name">healthCheckUrl</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">vipAddress</span>&gt;</span>cloudlink-user<span class="hljs-tag">&lt;/<span class="hljs-name">vipAddress</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">secureVipAddress</span>&gt;</span>cloudlink-user<span class="hljs-tag">&lt;/<span class="hljs-name">secureVipAddress</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">isCoordinatingDiscoveryServer</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">isCoordinatingDiscoveryServer</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">lastUpdatedTimestamp</span>&gt;</span>1555462894530<span class="hljs-tag">&lt;/<span class="hljs-name">lastUpdatedTimestamp</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">lastDirtyTimestamp</span>&gt;</span>1555462875800<span class="hljs-tag">&lt;/<span class="hljs-name">lastDirtyTimestamp</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">actionType</span>&gt;</span>ADDED<span class="hljs-tag">&lt;/<span class="hljs-name">actionType</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">instance</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span></span><br></pre></td></tr></table></figure><p>通过查看这几个Resource类的API不难发现, 真正的逻辑都在一个<code>PeerAwareInstanceRegistry registry</code>中完成</p><blockquote><p>注意区分registry和register</p></blockquote><p>来看下它的继承和实现关系</p><p><img src="https://blog-md-pic-1259135436.cos.ap-chengdu.myqcloud.com/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%93%E9%A2%98/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/registry%E7%BB%A7%E6%89%BF%E7%BB%93%E6%9E%84.jpg" alt="Registry"></p><p>其中<code>LeaseManager</code>中定义了实例注册(register), 续约(renew), 取消(cancel), 剔除(evict)的声明</p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">LeaseManager</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">register</span><span class="hljs-params">(T r, <span class="hljs-keyword">int</span> leaseDuration, <span class="hljs-keyword">boolean</span> isReplication)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">cancel</span><span class="hljs-params">(String appName, String id, <span class="hljs-keyword">boolean</span> isReplication)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">renew</span><span class="hljs-params">(String appName, String id, <span class="hljs-keyword">boolean</span> isReplication)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">evict</span><span class="hljs-params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进入其中一个实现类, 样子是这样</p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Override</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">register</span><span class="hljs-params">(<span class="hljs-keyword">final</span> InstanceInfo info, <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">int</span> leaseDuration = Lease.DEFAULT_DURATION_IN_SECS; <span class="hljs-comment">// 默认90s</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (info.getLeaseInfo() != <span class="hljs-keyword">null</span> &amp;&amp; info.getLeaseInfo().getDurationInSecs() &gt; <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        leaseDuration = info.getLeaseInfo().getDurationInSecs();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">super</span>.register(info, leaseDuration, isReplication);</span><br><span class="line">    replicateToPeers(Action.Register, info.getAppName(), info.getId(), info, <span class="hljs-keyword">null</span>, isReplication);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里做了两件事:</p><ol><li>调用父类register方法, 传入服务注册所需要的信息(例如服务名, 实例ID等)</li><li>调用replicateToPeers方法, 拿到所有对等的Eureka Server节点的信息, 把实例的更改信息复制到各节点中, 也就是Peer Replicate过程</li></ol><blockquote><p>这里的leaseDuration对应配置项<code>eureka.instance.lease-expiration-duration-in-seconds</code>, 默认90s</p></blockquote><p>Registry的流程如下:</p><p><img src="https://blog-md-pic-1259135436.cos.ap-chengdu.myqcloud.com/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%93%E9%A2%98/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/eureka%20server%20register.png" alt="Eureka Server Register"></p><p>看到这里, 剩下的就是进入父类<code>AbstractInstanceRegistry</code>去查看细节了, 而Renew, Cancel的过程基本都是如此, 不说了</p><p>下面对其中一些重点概念进行分析</p><p><br></p><h4 id="说明Registry"><a href="#说明Registry" class="headerlink" title="说明Registry"></a>说明Registry</h4><p>在LeaseManager中的几个实现中, 都能看到这样一个数据结构</p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; registry;</span><br></pre></td></tr></table></figure><p>如果能区分应用和实例的概念, 那就很好理解这个结构啦</p><p>翻译过来就是这样的: <code>Map&lt;应用名, Map&lt;实例名, 实例的信息以及该实例续约相关的时间戳&gt;&gt;</code></p><p>举个例子, 向Eureka Server注册了两个服务server-a, server-b, 其中server-a有两个实例, 端口为8801, 8802</p><p>那么registry的结构为<br></p><figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="hljs-attr">"SERVER-A"</span>: &#123;</span><br><span class="line">    <span class="hljs-attr">"192.168.153.1:server-a:8802"</span>: Lease&lt;InstanceInfo&gt;,</span><br><span class="line">    <span class="hljs-attr">"192.168.153.1:server-a:8801"</span>: Lease&lt;InstanceInfo&gt;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="hljs-attr">"SERVER-B"</span>: &#123;</span><br><span class="line">    <span class="hljs-attr">"192.168.153.1:server-b:8901"</span>: Lease&lt;InstanceInfo&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><br></p><h4 id="说明RecentlyChangedQueue"><a href="#说明RecentlyChangedQueue" class="headerlink" title="说明RecentlyChangedQueue"></a>说明RecentlyChangedQueue</h4><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConcurrentLinkedQueue&lt;RecentlyChangedItem&gt; recentlyChangedQueue;</span><br></pre></td></tr></table></figure><p>字面翻译是最近改变的队列, 在register, cancel, statusUpdate中, 都能看到对该队列添加了一个租约的变更记录</p><p>RecentlyChangedItem中存放了两个属性:</p><ul><li>leaseInfo: 租约</li><li>lastUpdateTime: 上次更新时间</li></ul><p>在register中, 还有一个定时任务, 会对该队列定期进行移除<br></p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Timer deltaRetentionTimer = <span class="hljs-keyword">new</span> Timer(<span class="hljs-string">"Eureka-DeltaRetentionTimer"</span>, <span class="hljs-keyword">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">this</span>.deltaRetentionTimer.schedule(getDeltaRetentionTask(),</span><br><span class="line">                serverConfig.getDeltaRetentionTimerIntervalInMs(),</span><br><span class="line">                serverConfig.getDeltaRetentionTimerIntervalInMs());</span><br></pre></td></tr></table></figure><p></p><p>来看下具体要执行的任务是什么<br></p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> TimerTask <span class="hljs-title">getDeltaRetentionTask</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TimerTask() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            Iterator&lt;RecentlyChangedItem&gt; it = recentlyChangedQueue.iterator();</span><br><span class="line">            <span class="hljs-keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                <span class="hljs-keyword">if</span> (it.next().getLastUpdateTime() &lt;</span><br><span class="line">                        System.currentTimeMillis() - serverConfig.getRetentionTimeInMSInDeltaQueue()) &#123;</span><br><span class="line">                    it.remove();</span><br><span class="line">                &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                    <span class="hljs-keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>在EurekaServer的配置bean中可以找到上述代码中的两个配置的默认值<br></p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 租约变更的过期时间</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> retentionTimeInMSInDeltaQueue = <span class="hljs-number">3</span> * MINUTES;</span><br><span class="line"><span class="hljs-comment">// 移除租约变更记录的定时器的执行间隔时间</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> deltaRetentionTimerIntervalInMs = <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>;</span><br></pre></td></tr></table></figure><p></p><p>关注if块中的移除条件就好, 也就是说会该任务每30秒执行一次, 移除最后更新时间距离现在超过180秒的租约记录</p><blockquote><p>像不像一个距离为180s的滑动窗口?</p></blockquote><p><br></p><h4 id="Evict"><a href="#Evict" class="headerlink" title="Evict"></a>Evict</h4><p>与实例注册, 发送心跳不同的是实例的剔除是Eureka Server主动来做的, 定期剔除无效的服务</p><ul><li><p>Server端定期执行剔除任务的默认周期为60s</p><p>配置项: <code>eureka.server.eviction-interval-timer-in-ms</code></p></li><li><p>无效的服务是指未在指定时间内收到心跳(也就是未进行renew汇报的服务)</p><p>默认的时间上限为90s, 配置项: <code>eureka.instance.lease-expiration-duration-in-seconds</code></p></li></ul><p>代码在这里<code>AbstractInstanceRegistry#evict()</code>, 又是一个定时任务</p><p>这点从Eureka Server不停打出的INFO日志也能看出来<br></p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[a-EvictionTimer] c.n.e.registry.AbstractInstanceRegistry  : Running the evict task with compensationTime 0ms</span><br></pre></td></tr></table></figure><p></p><p>定义如下:<br></p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">private</span> Timer evictionTimer = <span class="hljs-keyword">new</span> Timer(<span class="hljs-string">"Eureka-EvictionTimer"</span>, <span class="hljs-keyword">true</span>);</span><br></pre></td></tr></table></figure><p></p><p><br></p><h4 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h4><p>ResponseCacheImpl是Eureka Server缓存的实现, 通过读写缓存来降低读写竞争, 增大并发</p><p>在服务注册, 下线, 状态改变和剔除失效服务中, 都能看到这样一个方法<code>invalidateCache()</code>, 让什么缓存失效?</p><p>涉及到Eureka Server中两个很重要的缓存:</p><ul><li><code>ResponseCacheImpl#readOnlyCacheMap</code></li><li><code>ResponseCacheImpl#readWriteCacheMap</code></li></ul><p>从名字也能看出一个只读锁, 一个读写锁.</p><p>前者是ConcurrentMap, 后者是Guava Cache 它的写失效时间, Load方法都在ResponseCacheImpl的构造函数中定义了</p><p>而在<code>invalidateCache()</code>中, 最终操作的都是readWriteCacheMap,</p><p>readOnlyCacheMap负责所有客户端读取实例信息的请求, 那么它的值从哪来, 我看到两种方式:</p><ul><li><p><strong>方式一: getIfNotExist</strong>:</p><p>在<code>ResponseCacheImpl#getValue</code>中可以看到首先会从readOnlyCacheMap读, 如果不存在就从readWriteCacheMap拿, 然后放到readOnlyCacheMap中</p></li><li><p><strong>方式二: Timer</strong></p><p>在<code>ResponseCacheImpl#timer</code>中定义了一个缓存填充的定时器, 在定时器的Task<code>ResponseCacheImpl#getCacheUpdateTask</code>中可以看到会将readWriteCacheMap的内容copy到readOnlyCacheMap</p></li></ul><p>注意这两部分源码中都有一个if判断<code>shouldUseReadOnlyResponseCache</code>, 对应配置项<code>eureka.server.use-read-only-response-cache</code>, 默认为true, 字面翻译很清楚, 相当于开启只读缓存, 不开的话也就没有定时复制的任务了, 直接从读写缓存中拿了</p><p><br></p><h4 id="Peer-Replicate"><a href="#Peer-Replicate" class="headerlink" title="Peer Replicate"></a>Peer Replicate</h4><p>对应架构图中Eureka Server之间的Replicate</p><p><strong>isReplication</strong></p><p>需要注意的是通过查看几个resource API, 都能发现一个放在Header的参数<code>isReplication</code>. 例如</p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@POST</span></span><br><span class="line"><span class="hljs-meta">@Consumes</span>(&#123;<span class="hljs-string">"application/json"</span>, <span class="hljs-string">"application/xml"</span>&#125;)</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">addInstance</span><span class="hljs-params">(InstanceInfo info, @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication) </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>这是因为Eureka Server依赖Eureka Client, 因为Eureka Server也要作为其它Eureka Server的Client,</p><p>所以通过<code>isReplication</code>来区分是来自于其它peer的复制请求还是来自与普通的client实例的请求,</p><p>如果Eureka Server收到属于复制请求的, 就不会再复制给其它Peer, 防止死循环</p><p>还需要注意的是在InstanceInfo有一个<code>lastDirtyTimestamp</code>字段, 类似于版本号的概念, 在Peer Replication的过程中会对其进行比较, 在判断数据冲突的情况下, 返回4xx,</p><p>让应用实例重新register或同步信息, 来避免复制的冲突问题</p><p>前面说过<code>replicateToPeers()</code>的入口点, 这个过程实际是将instance修改信息添加到一个批量任务中打包发送给其他peer</p><p>源码参考: <code>com.netflix.eureka.cluster.PeerEurekaNode</code></p><p>里面可以看到创建Batch Task的过程, 由于是异步, 所以并不能保证在服务实例状态发生梗概时, 所有Peer上的信息都一致.</p><blockquote><p>Eureka Server端采用的是P2P的复制模式, 但是它不保证复制一定成功, 因此还通过与Eureka Client定期进行hearbeat, Server端内部的矫正机制来做应用实例信息的数据修复, 尽力提供一个最终一致性的服务实例视图</p></blockquote><p><br></p><h3 id="Eureka-Client"><a href="#Eureka-Client" class="headerlink" title="Eureka Client"></a><strong>Eureka Client</strong></h3><p>通过以上Eureka Server中的, 基本对架构图中的Register, Renew, Cancel过程有了基本的认识</p><p>再来简单说说Eureka Client</p><p><br></p><h4 id="provider"><a href="#provider" class="headerlink" title="provider"></a>provider</h4><p>对于Client端的Provider来说, 在启动和实例状态变化是, 需要通知Server端</p><p>源码参考(有序):</p><ul><li><code>com.netflix.discovery.InstanceInfoReplicator#onDemandUpdate</code></li><li><code>com.netflix.discovery.DiscoveryClient#register</code></li><li><code>com.netflix.discovery.shared.transport.decorator.EurekaHttpClientDecorator#register</code></li><li><code>com.netflix.discovery.shared.transport.jersey.AbstractJerseyEurekaHttpClient#register</code></li></ul><p>流程图如下:<br><img src="https://blog-md-pic-1259135436.cos.ap-chengdu.myqcloud.com/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%93%E9%A2%98/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/Eureka%20Client%20Provider%20Register.png" alt="Eureka Client Provider Register"></p><p>同样, Renew, Cancel的过程也参照这个顺序</p><p><br></p><h4 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h4><p>对于Client端的Consumer来说, 需要拉取服务实例的列表并缓存, 还需要定期更新</p><p>流程如下图</p><p><img src="https://blog-md-pic-1259135436.cos.ap-chengdu.myqcloud.com/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%93%E9%A2%98/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/Eureka%20Client%20Consumer%20Fetch%20Service%20Registries.png" alt="Eureka Client Consumer Fetch Service Registries"></p><p><img src="https://blog-md-pic-1259135436.cos.ap-chengdu.myqcloud.com/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%93%E9%A2%98/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/Eureka%20Client%20Consumer%20Update%20Service%20Registries.png" alt="Eureka Client Consumer Update Service Registries"></p><p><br></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p>Netflix Eureka是典型的注册中心+嵌入式客户端架构, 并且各节点之间对等</p><p>通过上面的分析, 对Netflix Eureka架构图中的各个过程都有了一定的了解, 以及一些配置项的细节</p><p>能够发现的一点是, 无论Eureka Server之间Peer to Peer的Replicate过程, 还是Eureka Client向Eureka Server发起Get Service Registries的过程</p><p>实现中看到了大量的schedule, cache, 异步过程, 以及Eureka的自我保护机制, 这种模型简化了集群管理的复杂度, 易于实现高可扩展性.</p><p>但是并不能完全保证强一致, 而是最终一致性.</p><p>刚刚接触Eureka的新手肯定能够发现, 为什么在服务上线/下线后, 注册中心并没有立刻感知到, 而是间隔了若干时间.</p><p>这在很多业务场景下是能够满足的, 因为作为Eureka客户端来说, 通常都会配置Ribbon提供失败重试, 尤其对于服务发现这一场景, 即使返回了非最新的服务供消费者调用, 也比什么都不返回好</p><p>也就是<a href="https://medium.com/knerd/eureka-why-you-shouldnt-use-zookeeper-for-service-discovery-4932c5c7e764" target="_blank" rel="noopener">Eureka! Why You Shouldn’t Use ZooKeeper for Service Discovery</a></p><blockquote><p>可参考中文翻译: <a href="https://blog.csdn.net/jenny8080/article/details/52448403" target="_blank" rel="noopener">https://blog.csdn.net/jenny8080/article/details/52448403</a></p></blockquote><p>这也是Eureka与其它几个服务发现组件(Zookeeper, Etcd, Consul)显著的区别. 在CAP理论中, Eureka保证AP, 其它几个保证CP</p><p><br></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a><strong>参考资料</strong></h2><ul><li><a href="https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance" target="_blank" rel="noopener">Eureka at a glance</a></li><li><a href="https://nobodyiam.com/2016/06/25/dive-into-eureka/" target="_blank" rel="noopener">Dive into Eureka</a></li></ul></div><ul class="post-copyright"><li><strong>本文标题：</strong><a href="https://xiefayang.com/2019/04/16/源码分析—服务发现组件Netflix Eureka/">源码分析——服务发现组件Netflix Eureka</a></li><li><strong>本文作者：</strong><a href="https://xiefayang.com">i蝸居年華_谢谢谢</a></li><li><strong>本文链接：</strong><a href="https://xiefayang.com/2019/04/16/源码分析—服务发现组件Netflix Eureka/">https://xiefayang.com/2019/04/16/源码分析—服务发现组件Netflix Eureka/</a></li><li><strong>发布时间：</strong>2019-04-16</li><li><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</li></ul><div class="level is-size-7 is-uppercase"><div class="level-start"><div class="level-item"> <span class="is-size-6 has-text-grey has-mr-7">#</span> <a class="has-link-grey -link" href="/tags/微服务/">微服务</a></div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">坚持原创技术分享，您的支持将鼓励我继续创作！</h3><div class="buttons is-centered"><a class="button is-info donate"><span class="icon is-small"><i class="fab fa-alipay"></i></span> <span>支付宝</span><div class="qrcode"><img src="/images/no2.jpg" alt="支付宝"></div></a><a class="button is-success donate"><span class="icon is-small"><i class="fab fa-weixin"></i></span> <span>微信</span><div class="qrcode"><img src="/images/no.gif" alt="微信"></div></a></div></div></div><div class="card card-transparent"><div class="level post-navigation is-flex-wrap is-mobile"><div class="level-start"><a class="level level-item has-link-grey article-nav-prev" href="/2019/04/19/服务发现——需求与模式/"><i class="level-item fas fa-chevron-left"></i> <span class="level-item">服务发现——需求与模式</span></a></div><div class="level-end"> <a class="level level-item has-link-grey article-nav-next" href="/2019/04/10/扒谱系列—音程和音符/"><span class="level-item">扒谱系列—音程和音符</span><i class="level-item fas fa-chevron-right"></i></a></div></div></div><div class="card"><div class="card-content"><h3 class="title is-5 has-text-weight-normal">评论</h3><div id="valine-thread" class="content"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="/js/Valine.min.js"></script><script>new Valine({el:"#valine-thread",notify:!1,verify:!1,app_id:"yVPV2fAKC1B90Xnh2JjuPEAb-gzGzoHsz",app_key:"1i9DgF7j75Uq6OuM23etjjE9",placeholder:"Just go go, 支持Markdown~"})</script></div></div></div><div class="column is-4-tablet is-4-desktop is-3-widescreen has-order-1 column-left"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered"><div> <img class="image is-128x128 has-mb-6" src="/images/avatar.png" alt="i蝸居年華_谢谢谢" style="border-radius:50%"><p class="is-size-4 is-block"> i蝸居年華_谢谢谢</p><p class="is-size-6 is-block"> Just for fun</p><p class="is-size-6 is-flex is-flex-center has-text-grey"><i class="fas fa-map-marker-alt has-mr-7"></i> <span>Beijing, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading"> 文章</p><p class="title has-text-weight-normal"> 47</p></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading"> 分类</p><p class="title has-text-weight-normal"> 13</p></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading"> 标签</p><p class="title has-text-weight-normal"> 32</p></div></div></nav><div class="level"> <a class="level-item button is-link is-rounded" href="https://github.com/thank037" target="_blank">关注我</a></div><div class="level is-mobile"> <a class="level-item button is-white is-marginless" target="_blank" title="github" href="https://github.com/thank037" name><img src="/images/github.svg" style="width:20px;height:20px"></a> <a class="level-item button is-white is-marginless" target="_blank" title="gitee" href="https://gitee.com/thank037" name><img src="/images/gitee.svg" style="width:20px;height:20px"></a> <a class="level-item button is-white is-marginless" target="_blank" title="weibo" href="https://weibo.com/u/2139090054" name><img src="/images/weibo.svg" style="width:20px;height:20px"></a> <a class="level-item button is-white is-marginless" target="_blank" title="email" href="mailto:coderthank@163.com" name><img src="/images/email.svg" style="width:20px;height:20px"></a></div></div></div><div class="card widget column-left is-sticky" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label"> 文章目录</h3><ul class="menu-list"><li> <a class="is-flex" href="#前言"><span class="has-mr-6">1</span> <span>前言</span></a></li><li> <a class="is-flex" href="#说明"><span class="has-mr-6">2</span> <span>说明</span></a><ul class="menu-list"><li> <a class="is-flex" href="#环境准备"><span class="has-mr-6">2.1</span> <span>环境准备</span></a></li><li> <a class="is-flex" href="#架构图"><span class="has-mr-6">2.2</span> <span>架构图</span></a></li></ul></li><li> <a class="is-flex" href="#源码解析"><span class="has-mr-6">3</span> <span>源码解析</span></a><ul class="menu-list"><li> <a class="is-flex" href="#Eureka-Server"><span class="has-mr-6">3.1</span> <span>Eureka Server</span></a><ul class="menu-list"><li> <a class="is-flex" href="#启动入口"><span class="has-mr-6">3.1.1</span> <span>启动入口</span></a></li><li> <a class="is-flex" href="#Resources-API"><span class="has-mr-6">3.1.2</span> <span>Resources API</span></a></li><li> <a class="is-flex" href="#Register-amp-Renew-amp-Cancel"><span class="has-mr-6">3.1.3</span> <span>Register&amp;Renew&amp;Cancel</span></a></li><li> <a class="is-flex" href="#说明Registry"><span class="has-mr-6">3.1.4</span> <span>说明Registry</span></a></li><li> <a class="is-flex" href="#说明RecentlyChangedQueue"><span class="has-mr-6">3.1.5</span> <span>说明RecentlyChangedQueue</span></a></li><li> <a class="is-flex" href="#Evict"><span class="has-mr-6">3.1.6</span> <span>Evict</span></a></li><li> <a class="is-flex" href="#缓存"><span class="has-mr-6">3.1.7</span> <span>缓存</span></a></li><li> <a class="is-flex" href="#Peer-Replicate"><span class="has-mr-6">3.1.8</span> <span>Peer Replicate</span></a></li></ul></li><li> <a class="is-flex" href="#Eureka-Client"><span class="has-mr-6">3.2</span> <span>Eureka Client</span></a><ul class="menu-list"><li> <a class="is-flex" href="#provider"><span class="has-mr-6">3.2.1</span> <span>provider</span></a></li><li> <a class="is-flex" href="#Consumer"><span class="has-mr-6">3.2.2</span> <span>Consumer</span></a></li></ul></li></ul></li><li> <a class="is-flex" href="#总结"><span class="has-mr-6">4</span> <span>总结</span></a></li><li> <a class="is-flex" href="#参考资料"><span class="has-mr-6">5</span> <span>参考资料</span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start has-text-centered-mobile"> <a class="footer-logo is-block has-mb-6" href="/">i蝸居年華_谢谢谢</a><p class="is-size-7"> &copy; 2016—2019 i蝸居年華_谢谢谢&nbsp; 由<a href="http://hexo.io/" target="_blank">Hexo</a> 强力驱动<br> <span id="busuanzi_container_site_uv">您是第<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle"><p class="control"><a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/thank037"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN")</script><script src="/js/animation.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer="defer"></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer="defer"></script><script src="/js/gallery.js" defer="defer"></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now</a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer="defer"></script><script>document.addEventListener("DOMContentLoaded",function(){outdatedBrowser({bgColor:"#f25648",color:"#ffffff",lowerThan:"flex"})})</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer="defer"></script><script>document.addEventListener("DOMContentLoaded",function(){MathJax.Hub.Config({"HTML-CSS":{matchFontHeight:!1},SVG:{matchFontHeight:!1},CommonHTML:{matchFontHeight:!1},tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]]}})})</script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back-to-top.js" defer="defer"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer="defer"></script><script src="/js/clipboard.js" defer="defer"></script><script src="/js/main.js" defer="defer"></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"> <input type="text" class="searchbox-input ins-search-input" placeholder="全文搜索站内文章~"><span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(无标题)"},CONTENT_URL:"/content.json"}</script><script src="/js/insight.js" defer="defer"></script><link rel="stylesheet" href="/css/search.css"><link rel="stylesheet" href="/css/insight.css"><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"right",width:300,height:600,mobile:{show:!0},react:{opacity:.7}},log:!1})</script></body></html>